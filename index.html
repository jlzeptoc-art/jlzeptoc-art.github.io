<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Product Weight Calculator</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
  .card { max-width: 520px; padding: 1.25rem; border: 1px solid #ddd; border-radius: 8px; }
  label { display:block; margin-top: 0.75rem; font-weight: 600; }
  input, select { width:100%; padding:0.6rem; border:1px solid #ccc; border-radius:6px; }
  .row { display:flex; gap: 0.75rem; }
  .row > div { flex:1; }
  .result { margin-top: 1rem; padding: 0.75rem; background: #f7f7f7; border-radius:6px; }
  .muted { color:#666; font-size: 0.9rem; }
  .note { font-size: 0.85rem; color:#444; margin-top:0.5rem; }
</style>
</head>
<body>
  <div class="card">
    <h2>Product Lookup (SPG)</h2>
    <label for="csvFile">Upload SPG Spreadsheet (CSV)</label>
    <input id="csvFile" type="file" accept=".csv">

    <label for="productSearch">Search by Product Number</label>
    <input id="productSearch" type="text" placeholder="e.g. 12345" autocomplete="off">

    <label for="bottle">Bottle Type</label>
    <select id="bottle"></select>

    <div class="note muted">Upload a CSV with columns for Product Number, Name, and SPG. Searching will show only the product name and SPG.</div>
    <div class="result" id="productResult"></div>
  </div>

<script>
const bottleTypes = [
  { key: "gallon_white_natural", name: "Gallon (White/Natural HDPE)", tare: 0.30, nominalOz: 128 },
  { key: "gallon_clear", name: "Gallon (Clear/PET)", tare: 0.32, nominalOz: 128 },
  { key: "half_gallon", name: "Half Gallon (64 oz)", tare: 0.16, nominalOz: 64 },
  { key: "quart", name: "Quart (32 oz)", tare: 0.08, nominalOz: 32 },
  { key: "pint", name: "Pint (16 oz)", tare: 0.05, nominalOz: 16 },
  { key: "8oz", name: "Bottle (8 oz)", tare: 0.03, nominalOz: 8 },
  { key: "4oz", name: "Bottle (4 oz)", tare: 0.02, nominalOz: 4 },
  { key: "drum_5gal", name: "5 Gallon Pail", tare: 1.80, nominalOz: 640 }
];

function fillBottleSelect() {
  const sel = document.getElementById('bottle');
  sel.innerHTML = "";
  bottleTypes.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.key;
    const cap = b.nominalOz ? ` â€“ ${b.nominalOz} oz` : "";
    opt.textContent = `${b.name}${cap} (tare ${b.tare.toFixed(3)} lb)`;
    sel.appendChild(opt);
  });
}

// Product CSV handling and search
const productIndex = new Map();
let detectedColumns = { numberKey: null, nameKey: null, spgKey: null };

function normalizeHeaderName(header) {
  return String(header || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ');
}

function detectColumnKeys(headers) {
  const normalizedToOriginal = new Map(headers.map(h => [normalizeHeaderName(h), h]));
  const numberCandidates = ['product number','number','sku','id','code','item number','item #','item no'];
  const nameCandidates = ['product name','name','description','item name','title'];
  const spgCandidates = ['spg','specific gravity','specificgravity','specific_gravity'];

  function firstExisting(candidates) {
    for (const c of candidates) {
      if (normalizedToOriginal.has(c)) return normalizedToOriginal.get(c);
    }
    return null;
  }

  return {
    numberKey: firstExisting(numberCandidates),
    nameKey: firstExisting(nameCandidates),
    spgKey: firstExisting(spgCandidates)
  };
}

function parseCSV(text) {
  const rows = [];
  let current = [];
  let field = '';
  let inQuotes = false;
  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    if (inQuotes) {
      if (char === '"') {
        const next = text[i + 1];
        if (next === '"') { field += '"'; i++; }
        else { inQuotes = false; }
      } else {
        field += char;
      }
    } else {
      if (char === '"') {
        inQuotes = true;
      } else if (char === ',') {
        current.push(field);
        field = '';
      } else if (char === '\n') {
        current.push(field);
        rows.push(current);
        current = [];
        field = '';
      } else if (char === '\r') {
        // ignore
      } else {
        field += char;
      }
    }
  }
  if (field.length > 0 || current.length > 0) {
    current.push(field);
    rows.push(current);
  }
  if (rows.length === 0) return { headers: [], records: [] };
  const headers = rows[0];
  const records = rows.slice(1)
    .filter(r => r.some(cell => String(cell).trim().length > 0))
    .map(r => Object.fromEntries(headers.map((h, idx) => [h, r[idx] ?? ''])));
  return { headers, records };
}

function loadProductsFromCSV(text) {
  const { headers, records } = parseCSV(text);
  if (!headers || headers.length === 0) {
    showProductResult('CSV missing header row.');
    return;
  }
  detectedColumns = detectColumnKeys(headers);
  if (!detectedColumns.numberKey || !detectedColumns.nameKey || !detectedColumns.spgKey) {
    showProductResult('Could not find required columns (Number, Name, SPG).');
    return;
  }
  productIndex.clear();
  for (const rec of records) {
    const numberRaw = String(rec[detectedColumns.numberKey] ?? '').trim();
    const name = String(rec[detectedColumns.nameKey] ?? '').trim();
    const spgRaw = String(rec[detectedColumns.spgKey] ?? '').trim();
    if (!numberRaw) continue;
    const spg = parseFloat(spgRaw.replace(/[^0-9.\-]/g, ''));
    productIndex.set(numberRaw, { number: numberRaw, name, spg: Number.isFinite(spg) ? spg : null });
  }
  showProductResult(`Loaded ${productIndex.size} products. Enter a product number.`);
}

function showProductResult(content) {
  const res = document.getElementById('productResult');
  res.innerHTML = typeof content === 'string' ? `<div class="muted">${content}</div>` : content;
}

function renderFoundProduct(product) {
  const safeName = product.name || '(no name)';
  const spgText = product.spg == null ? '(unknown)' : product.spg.toFixed(3);
  showProductResult(`
    <div><strong>Name:</strong> ${safeName}</div>
    <div><strong>SPG:</strong> ${spgText}</div>
  `);
}

function handleSearch() {
  const term = document.getElementById('productSearch').value.trim();
  if (productIndex.size === 0) {
    showProductResult('Upload a CSV first.');
    return;
  }
  if (!term) {
    showProductResult('Enter a product number to search.');
    return;
  }
  const found = productIndex.get(term) || null;
  if (found) renderFoundProduct(found);
  else showProductResult(`No product found for number "${term}".`);
}

fillBottleSelect();

document.getElementById('csvFile').addEventListener('change', (e) => {
  const file = e.target.files && e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => loadProductsFromCSV(String(reader.result || ''));
  reader.readAsText(file);
});

document.getElementById('productSearch').addEventListener('input', handleSearch);
document.getElementById('productSearch').addEventListener('change', handleSearch);

// Initial hint
showProductResult('Upload a CSV, then search by product number.');
</script>
</body>
</html>
