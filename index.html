<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Product Weight Calculator</title>
  <link rel="icon" type="image/png" href="IMG_0274.png">
  <link rel="apple-touch-icon" href="IMG_0274.png">
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Modern font loading for better rendering -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ============================================
       DESIGN SYSTEM: Modern 2025 Palette
       ============================================ */
    :root{
      /* Color System - Professional, harmonious palette */
      --color-primary: #2563eb;           /* Modern blue - trustworthy & professional */
      --color-primary-dark: #1d4ed8;      /* Darker for hover states */
      --color-primary-light: #3b82f6;     /* Lighter variant */
      --color-primary-bg: #eff6ff;        /* Subtle blue background */
      
      --color-success: #10b981;           /* Green for success states */
      --color-success-bg: #d1fae5;        /* Light green background */
      --color-success-text: #065f46;      /* Dark green text */
      
      --color-warning: #f59e0b;           /* Amber for warnings */
      --color-warning-bg: #fef3c7;        /* Light amber background */
      --color-warning-text: #92400e;      /* Dark amber text */
      
      --color-error: #ef4444;             /* Red for errors */
      --color-error-bg: #fee2e2;          /* Light red background */
      --color-error-text: #991b1b;        /* Dark red text */
      
      /* Neutral Grays - Modern, not pure black/white */
      --color-bg: #f8fafc;                /* Off-white background */
      --color-surface: #ffffff;           /* Pure white for cards */
      --color-surface-elevated: #ffffff;  /* Elevated surfaces */
      --color-text-primary: #0f172a;      /* Dark gray, not black */
      --color-text-secondary: #475569;    /* Medium gray for secondary text */
      --color-text-tertiary: #94a3b8;     /* Light gray for muted text */
      --color-border: #e2e8f0;            /* Subtle borders */
      --color-border-strong: #cbd5e1;     /* Stronger borders */
      --color-hover: #f1f5f9;             /* Hover backgrounds */
      
      /* Shadows - Subtle depth */
      --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      
      /* Spacing Scale - Consistent rhythm */
      --space-xs: 0.25rem;
      --space-sm: 0.5rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      --space-2xl: 3rem;
      
      /* Typography Scale */
      --font-size-xs: 0.75rem;    /* 12px */
      --font-size-sm: 0.875rem;   /* 14px */
      --font-size-base: 1rem;     /* 16px */
      --font-size-lg: 1.125rem;   /* 18px */
      --font-size-xl: 1.25rem;    /* 20px */
      --font-size-2xl: 1.5rem;    /* 24px */
      --font-size-3xl: 1.875rem;  /* 30px */
      
      /* Border Radius */
      --radius-sm: 0.375rem;      /* 6px */
      --radius-md: 0.5rem;        /* 8px */
      --radius-lg: 0.75rem;       /* 12px */
      --radius-xl: 1rem;          /* 16px */
      --radius-full: 9999px;
      
      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
      
      /* Legacy compatibility */
      --bg: var(--color-bg);
      --panel: var(--color-surface);
      --text: var(--color-text-primary);
      --muted: var(--color-text-secondary);
      --accent: var(--color-primary);
      --accent-dark: var(--color-primary-dark);
      --border: var(--color-border);
      --hover: var(--color-hover);
    }
    
    *{
      box-sizing: border-box;
    }
    
    body{
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--color-bg);
      color: var(--color-text-primary);
      line-height: 1.6;
      font-size: var(--font-size-base);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* ============================================
       HEADER - Modern gradient with depth
       ============================================ */
    header{
      padding: var(--space-xl) var(--space-2xl);
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
      color: white;
      box-shadow: var(--shadow-lg);
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
    }
    
    .header-content{
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: var(--space-lg);
      max-width: 1600px;
      margin: 0 auto;
    }
    
    header h1{
      margin: 0;
      font-size: var(--font-size-3xl);
      font-weight: 800;
      letter-spacing: -0.025em;
      line-height: 1.2;
    }
    
    /* ============================================
       MAIN LAYOUT - Proper spacing
       ============================================ */
    main{
      padding: var(--space-2xl) var(--space-2xl);
      max-width: 1600px;
      margin: 0 auto;
      min-height: calc(100vh - 200px);
    }
    
    /* ============================================
       CARDS - Elevated surfaces with depth
       ============================================ */
    .card{
      max-width: 900px;
      margin: 0 auto;
      padding: var(--space-xl);
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      transition: box-shadow var(--transition-base);
    }
    
    .card:hover{
      box-shadow: var(--shadow-lg);
    }
    
    /* ============================================
       TYPOGRAPHY - Clear hierarchy
       ============================================ */
    h2{
      margin: 0 0 var(--space-lg) 0;
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--color-text-primary);
      letter-spacing: -0.02em;
      line-height: 1.3;
    }
    /* ============================================
       FORMS - Modern inputs with clear affordances
       ============================================ */
    label{
      display: block;
      margin-top: var(--space-lg);
      margin-bottom: var(--space-sm);
      font-weight: 600;
      color: var(--color-text-primary);
      font-size: var(--font-size-sm);
      letter-spacing: -0.01em;
    }
    
    input, select{
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1.5px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-family: inherit;
      background: var(--color-surface);
      color: var(--color-text-primary);
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
    }
    
    input:hover, select:hover{
      border-color: var(--color-border-strong);
      box-shadow: var(--shadow-md);
    }
    
    input:focus, select:focus{
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1), var(--shadow-sm);
    }
    
    select{
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 14 14'%3E%3Cpath fill='%232563eb' d='M7 10.5L2 5.5h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.875rem center;
      padding-right: 2.5rem;
      cursor: pointer;
    }
    /* ============================================
       LAYOUT UTILITIES
       ============================================ */
    .row{
      display: flex;
      gap: var(--space-md);
      flex-wrap: wrap;
    }
    
    .row > div{
      flex: 1;
      min-width: 220px;
    }
    
    /* ============================================
       TEXT UTILITIES
       ============================================ */
    .muted{
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      line-height: 1.5;
    }
    
    /* ============================================
       RESULTS - Highlighted output area
       ============================================ */
    .result{
      margin-top: var(--space-xl);
      padding: var(--space-xl);
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--color-border);
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
    }
    
    .result strong{
      color: var(--color-primary);
      font-weight: 600;
    }
    /* ============================================
       STATUS PILLS - Modern badges
       ============================================ */
    .pill{
      display: inline-block;
      padding: 0.375rem 0.75rem;
      border-radius: var(--radius-full);
      margin-top: var(--space-sm);
      font-size: var(--font-size-xs);
      font-weight: 600;
      letter-spacing: 0.01em;
      border: 1px solid transparent;
    }
    
    .ok{
      color: var(--color-success-text);
      background: var(--color-success-bg);
      border-color: rgba(16, 185, 129, 0.2);
    }
    
    .warn{
      color: var(--color-warning-text);
      background: var(--color-warning-bg);
      border-color: rgba(245, 158, 11, 0.2);
    }
    
    .err{
      color: var(--color-error-text);
      background: var(--color-error-bg);
      border-color: rgba(239, 68, 68, 0.2);
    }
    /* ============================================
       BUTTONS - Clear affordances, modern style
       ============================================ */
    button{
      appearance: none;
      border: 1.5px solid var(--color-primary);
      border-radius: var(--radius-md);
      padding: 0.75rem 1.5rem;
      font-size: var(--font-size-base);
      font-family: inherit;
      font-weight: 600;
      cursor: pointer;
      background: var(--color-primary);
      color: white;
      transition: all var(--transition-base);
      box-shadow: var(--shadow-sm);
      letter-spacing: -0.01em;
    }
    
    button:hover:not(:disabled){
      background: var(--color-primary-dark);
      border-color: var(--color-primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    button:active:not(:disabled){
      transform: translateY(0);
      box-shadow: var(--shadow-sm);
    }
    
    button:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2), var(--shadow-sm);
    }
    
    button:disabled{
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    button.primary{
      background: var(--color-primary);
      border-color: var(--color-primary);
    }
    
    /* Secondary button variant */
    button.secondary{
      background: var(--color-surface);
      border-color: var(--color-border-strong);
      color: var(--color-text-primary);
    }
    
    button.secondary:hover:not(:disabled){
      background: var(--color-hover);
      border-color: var(--color-border-strong);
    }
    
    .actions{
      display: flex;
      gap: var(--space-md);
      margin-top: var(--space-lg);
      flex-wrap: wrap;
    }
    /* ============================================
       SUGGESTIONS DROPDOWN - Elevated menu
       ============================================ */
    .suggestions{
      position: relative;
      margin-top: var(--space-sm);
    }
    
    .suggestions-list{
      position: absolute;
      z-index: 50;
      left: 0;
      right: 0;
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      max-height: 280px;
      overflow: auto;
      box-shadow: var(--shadow-xl);
      margin-top: var(--space-xs);
    }
    
    .suggestions-item{
      padding: 0.875rem 1rem;
      cursor: pointer;
      transition: background var(--transition-fast);
      font-size: var(--font-size-sm);
      color: var(--color-text-primary);
      border-bottom: 1px solid var(--color-border);
    }
    
    .suggestions-item:last-child{
      border-bottom: none;
    }
    
    .suggestions-item:hover{
      background: var(--color-primary-bg);
      color: var(--color-primary-dark);
    }
    
    .suggestions-empty{
      padding: 0.875rem 1rem;
      color: var(--color-text-tertiary);
      font-size: var(--font-size-sm);
      text-align: center;
    }
    /* ============================================
       FOOTER - Clean separation
       ============================================ */
    .footer-info{
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-2xl);
      padding-top: var(--space-xl);
      border-top: 1px solid var(--color-border);
      flex-wrap: wrap;
      gap: var(--space-lg);
    }
    
    .footer-info img{
      height: 50px;
      opacity: 0.85;
      transition: opacity var(--transition-base);
    }
    
    .footer-info img:hover{
      opacity: 1;
    }
    
    .footer-nav{
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }
    
    .footer-nav a{
      color: var(--color-primary);
      text-decoration: none;
      font-weight: 500;
      font-size: var(--font-size-sm);
      transition: all var(--transition-base);
      position: relative;
    }
    
    .footer-nav a::after{
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--color-primary);
      transition: width var(--transition-base);
    }
    
    .footer-nav a:hover{
      color: var(--color-primary-dark);
    }
    
    .footer-nav a:hover::after{
      width: 100%;
    }
    
    /* ============================================
       RESPONSIVE - Mobile-friendly
       ============================================ */
    @media (max-width: 768px) {
      header{
        padding: var(--space-lg) var(--space-lg);
      }
      
      header h1{
        font-size: var(--font-size-2xl);
      }
      
      main{
        padding: var(--space-lg);
      }
      
      .card{
        padding: var(--space-lg);
      }
      
      .row > div{
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Product Weight Calculator</h1>
    </div>
  </header>
  <main>
    <div class="card">
      <h2>Product Weight Calculator</h2> 
    <div class="muted">
      Assumption: 1 gallon @ SPG 1.000 = <strong>8.34 lb</strong> (128 fl oz).<br>
      Net = (bottle_ounces × SPG × 8.34 / 128). Gross = Net + tare.
    </div>

    <div id="loadStatus" class="muted" style="margin-top:.5rem;"></div>

    <label for="search" style="margin-top:1rem">Search by Item Number (formula) or Product Name</label>
    <div class="row">
      <div style="flex:2;min-width:260px">
        <input id="search" type="text" placeholder="Type item number or name; press Enter or click Search">
      </div>
      <div style="flex:0 0 auto;min-width:120px">
        <button id="searchBtn" class="primary" style="width:100%">Search</button>
      </div>
    </div>
    <div id="searchStatus" class="muted" style="margin-top:.25rem;"></div>
    <div id="suggestions" class="suggestions"></div>

    <div class="row" style="margin-top:.75rem;">
      <div>
        <label for="bottle">Bottle Type</label>
        <select id="bottle"></select>
      </div>
      <div>
        <label for="spg">Specific Gravity (SPG)</label>
        <input id="spg" type="number" step="0.001" min="0" value="1.000">
        <div class="muted">Auto-fills on match. You can override.</div>
      </div>
    </div>

    <div id="result" class="result"></div>
    <div class="actions">
      <button id="resetBtn" title="Clear selections">Reset</button>
    </div>
      <div class="footer-info">
        <div>
          <div class="muted" style="font-size:13px;">App made by <strong>J.L.</strong></div>
          <div class="footer-nav" style="margin-top:8px;">
            <a href="schedule.html">Production Schedule</a>
          </div>
        </div>
        <img src="maintex-logo.jpg" alt="Maintex Logo">
      </div>
    </div>
  </main>

<script>
/* ---------- CONFIG: single authoritative source ---------- */
const DATA_URL = "https://docs.google.com/spreadsheets/d/16_KVPSr7VIsCExEo-TPRnT8iI1Bd2rFDSNIj-JlLFMc/export?format=xlsx";

/* ---------- Constants ---------- */
const GALLON_LBS_AT_SPG1 = 8.34;

/* Bottle catalog (ounces + tare). Update if you have exact tares. */
const bottleTypes = [
  { key: "clear_round",          name: "Clear Round Bottle",           tare: 0.24, ounces: 160 },
  { key: "nat_160",              name: "Natural 160oz Bottle",         tare: 0.32, ounces: 160 },
  { key: "gallon_white_natural", name: "Gallon (White/Natural)",       tare: 0.30, ounces: 128 },
  { key: "gallon_fstyle",        name: "Gallon (F-Style)",             tare: 0.43, ounces: 128 },
  { key: "2liter_gallon",        name: "2L Clear Bottle",              tare: 0.16, ounces: 67 },
  { key: "half_gallon",          name: "Half Gallon",                  tare: 0.27, ounces: 64 },
  { key: "50oz",                 name: "50oz Bottle",                  tare: 0.11, ounces: 50 },
  { key: "quart",                name: "White/Natural Quart",          tare: 0.13, ounces: 32 },
  { key: "white_flat_quart",     name: "White Flat Quart",             tare: 0.18, ounces: 32 },
  { key: "clear_flat_quart",     name: "Clear Flat Quart",             tare: 0.16, ounces: 32 },
  { key: "clear_quart",          name: "Clear Quart",                  tare: 0.11, ounces: 32 },
  { key: "30oz",                 name: "30oz Bottle",                  tare: 0.11, ounces: 30 },
  { key: "pint",                 name: "Pint",                         tare: 0.14, ounces: 16 },
  { key: "12oz",                 name: "Bottle (12 oz)",               tare: 0.08, ounces: 12 },
  { key: "8oz",                  name: "Bottle (8 oz)",                tare: 0.03, ounces: 8 },
  { key: "pail_5gal",            name: "5 Gallon Pail",                tare: 3.06, ounces: 640 }
];

/* ---------- State ---------- */
let PRODUCTS = []; // { pn, name, spg }
let currentProduct = null; // Currently selected product record
const $ = (id) => document.getElementById(id);

/* ---------- UI helpers ---------- */
function setStatus(msg, kind='') {
  const s = $('searchStatus'); if (!s) return;
  s.textContent = msg || '';
  s.className = `${kind ? 'pill ' + kind : 'muted'}`;
}
function setLoadStatus(msg, kind='') {
  const s = $('loadStatus'); if (!s) return;
  s.textContent = msg || '';
  s.className = `${kind ? 'pill ' + kind : 'muted'}`;
}

function fillBottleSelect() {
  const sel = $('bottle');
  sel.innerHTML = "";
  bottleTypes.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.key;
    opt.textContent = `${b.name} – ${b.ounces} oz (tare ${b.tare.toFixed(3)} lb)`;
    sel.appendChild(opt);
  });
}

/* ---------- Header picking / normalization ---------- */
const norm = (s) => String(s ?? '').trim().toLowerCase();
function pickHeader(objKeys, regexList) {
  const lower = objKeys.map(k => ({ orig: k, low: norm(k) }));
  for (const rx of regexList) {
    const re = new RegExp(rx);
    const hit = lower.find(({low}) => re.test(low));
    if (hit) return hit.orig;
  }
  return null;
}

/* ---------- Ingest rows (formula, description, specific gravity) ---------- */
function ingestRows(rows) {
  if (!Array.isArray(rows) || rows.length === 0) {
    setLoadStatus('No rows found in sheet.', 'err'); PRODUCTS = []; return;
  }
  const keys = Object.keys(rows[0] || {});
  const pnKey   = pickHeader(keys, ['\\bformula\\b','\\bproduct\\s*(no|num|number)?\\b','\\bsku\\b','\\bitem(\\s*no|\\s*number)?\\b','\\bpart(\\s*no|\\s*number)?\\b']);
  const spgKey  = pickHeader(keys, ['\\bspecific\\s*gravity\\b','\\bspg\\b','\\bsg\\b']);
  const nameKey = pickHeader(keys, ['\\bdescription\\b','\\bproduct\\s*name\\b','\\bname\\b','\\btitle\\b']);
  if (!pnKey || !spgKey) {
    setLoadStatus('Missing product number (formula) and/or SPG columns.', 'err'); PRODUCTS = []; return;
  }
  const seen = new Set(); const out = [];
  for (const r of rows) {
    const pn   = String(r[pnKey] ?? '').trim();
    const name = String(r[nameKey] ?? '').trim();
    const spg  = Number(r[spgKey]);
    if (!pn || !Number.isFinite(spg)) continue;
    const key = norm(pn);
    if (seen.has(key)) continue;
    seen.add(key);
    out.push({ pn, name, spg });
  }
  PRODUCTS = out;
  setLoadStatus(`Loaded ${PRODUCTS.length} products from SG Sheet.`, 'ok');
}

/* ---------- XLSX loader (from fixed URL) ---------- */
  function getFilenameFromHeaders(resp) {
  const cd = resp.headers.get('content-disposition');
  if (!cd) return null;
  // patterns: filename="NAME.xlsx"  |  filename*=UTF-8''NAME.xlsx
  const star = cd.match(/filename\*\s*=\s*[^']*''([^;]+)/i);
  if (star && star[1]) return decodeURIComponent(star[1]).replace(/["]/g,'').trim();
  const plain = cd.match(/filename\s*=\s*"([^"]+)"/i) || cd.match(/filename\s*=\s*([^;]+)/i);
  if (plain && plain[1]) return plain[1].replace(/["]/g,'').trim();
  return null;
}

function getTitleFromWorkbook(wb) {
  // SheetJS populates Props.Title for many sources; fallback to first sheet name.
  if (wb && wb.Props && wb.Props.Title) return String(wb.Props.Title).trim();
  if (wb && Array.isArray(wb.SheetNames) && wb.SheetNames.length) return String(wb.SheetNames[0]).trim();
  return null;
}

 async function loadFromURL(url) {
  setLoadStatus('Loading spreadsheet…');
  try {
    const resp = await fetch(url, { cache: 'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    // Try to get a real filename from headers first
    let fileName = getFilenameFromHeaders(resp);

    const ab = await resp.arrayBuffer();
    const wb = XLSX.read(new Uint8Array(ab), { type: 'array' });

    if (!wb.SheetNames?.length) throw new Error('No sheets in workbook');
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

    ingestRows(rows);

    // If no header-derived filename, fall back to workbook metadata/sheet name
    if (!fileName) {
      const title = getTitleFromWorkbook(wb);
      if (title) {
        // Ensure it looks like a file name
        fileName = title.endsWith('.xlsx') ? title : `${title}.xlsx`;
      }
    }

    // Final fallback: last URL segment (your current behavior)
    if (!fileName) {
      fileName = url.split('/').pop().split('?')[0] || 'data.xlsx';
      if (!/\.xlsx$/i.test(fileName)) fileName += '.xlsx';
    }

    setLoadStatus(`Loaded ${PRODUCTS.length} products from "${fileName}".`, 'ok');

  } catch (err) {
    setLoadStatus(`Load failed: ${err.message}. Ensure the sheet is public and the link uses /export?format=xlsx.`, 'err');
    PRODUCTS = [];
  }
}



/* ---------- Search & calc ---------- */
function findProduct(pnRaw) {
  const key = norm(pnRaw);
  if (!key) return null;
  return PRODUCTS.find(r => norm(r.pn) === key) || null;
}

function findProductFlexible(qRaw){
  const q = norm(qRaw);
  if (!q) return null;
  // exact item number
  let hit = PRODUCTS.find(r => norm(r.pn) === q);
  if (hit) return hit;
  // exact name
  hit = PRODUCTS.find(r => norm(r.name) === q);
  if (hit) return hit;
  // contains in pn or name
  hit = PRODUCTS.find(r => norm(r.pn).includes(q) || norm(r.name).includes(q));
  return hit || null;
}

function getSuggestions(qRaw, limit=8){
  const q = norm(qRaw);
  if (!q) return [];
  const scored = PRODUCTS.map(r => {
    const pn = norm(r.pn), nm = norm(r.name);
    let score = 0;
    if (pn.startsWith(q)) score += 3;
    if (nm.startsWith(q)) score += 2;
    if (pn.includes(q)) score += 1;
    if (nm.includes(q)) score += 1;
    return { r, score };
  }).filter(x => x.score > 0);
  scored.sort((a,b) => b.score - a.score);
  return scored.slice(0, limit).map(x => x.r);
}

function lookupProduct() {
  const query = $('search').value;
  if (!PRODUCTS.length) { setStatus('Data not loaded yet. Check status above.', 'warn'); return; }
  if (!query.trim())    { setStatus('Enter an item number or name to search.', ''); renderSuggestions([]); currentProduct = null; return; }
  const rec = findProductFlexible(query);
  if (rec) {
    $('spg').value = String(rec.spg);
    const nameStr = rec.name ? ` • ${rec.name}` : '';
    setStatus(`Found ${rec.pn}${nameStr} → SPG ${Number(rec.spg).toFixed(3)}`, 'ok');
    localStorage.setItem('pw_pn', rec.pn);
    currentProduct = rec; // Store the selected product
    calc(rec);
    renderSuggestions([]);
  } else {
    setStatus(`No exact match. Suggestions shown below…`, 'warn');
    renderSuggestions(getSuggestions(query));
    currentProduct = null; // Clear current product if not found
  }
}

function calc(rec=null) {
  // Use provided rec, or fall back to currentProduct, or try to restore from search field
  let productRec = rec;
  if (!productRec && currentProduct) {
    productRec = currentProduct;
  } else if (!productRec) {
    // Try to find product from search field value
    const searchValue = $('search').value.trim();
    if (searchValue) {
      productRec = findProductFlexible(searchValue);
      if (productRec) {
        currentProduct = productRec;
      }
    }
  } else {
    // If rec is provided, update currentProduct
    currentProduct = rec;
  }
  
  const key = $('bottle').value;
  const bottle = bottleTypes.find(b => b.key === key) || bottleTypes[0];
  const spg = parseFloat($('spg').value || "0");
  const net = (bottle.ounces * spg * GALLON_LBS_AT_SPG1) / 128.0;
  const gross = net + bottle.tare;
  const productName = productRec?.name ? ` • ${productRec.name}` : '';
  localStorage.setItem('pw_bottle', bottle.key);
  if (Number.isFinite(spg)) localStorage.setItem('pw_spg', String(spg));
  if (productRec?.pn) localStorage.setItem('pw_pn', productRec.pn);
  $('result').innerHTML = `
    <div><strong>Net:</strong> ${Number.isFinite(net) ? net.toFixed(3) : '—'} lb</div>
    <div><strong>Gross:</strong> ${Number.isFinite(gross) ? gross.toFixed(3) : '—'} lb</div>
    <div class="muted">
      Product: ${productRec?.pn ?? '—'}${productName}<br>
      Bottle: ${bottle.name} • ${bottle.ounces} oz • Tare ${bottle.tare.toFixed(3)} lb • SPG ${Number.isFinite(spg) ? spg.toFixed(3) : '—'}
    </div>
  `;
}

function selectProductByPN(pnRaw) {
  const key = (pnRaw ?? '').toString().trim().toLowerCase();
  const rec = PRODUCTS.find(x => (x.pn ?? '').toString().trim().toLowerCase() === key);
  if (!rec) { setStatus(`Item "${pnRaw}" not found.`, 'warn'); currentProduct = null; return; }
  $('search').value = rec.pn;               // show the PN in the box
  $('spg').value = String(rec.spg);         // set SPG
  setStatus(`Found ${rec.pn}${rec.name ? ' • ' + rec.name : ''} → SPG ${Number(rec.spg).toFixed(3)}`, 'ok');
  renderSuggestions([]);                    // hide suggestions
  localStorage.setItem('pw_pn', rec.pn);    // persist
  currentProduct = rec;                     // Store the selected product
  calc(rec);                                // compute with the exact record
}


function renderSuggestions(items){
  const host = $('suggestions');
  if (!host) return;
  host.style.display = 'none';
  host.innerHTML = '';

  if (!items || !items.length){
    // keep empty hidden
    return;
  }

  const list = document.createElement('div');
  list.className = 'suggestions-list';

  items.forEach(r => {
    const div = document.createElement('div');
    div.className = 'suggestions-item';
    const nameStr = r.name ? ` • ${r.name}` : '';
    div.textContent = `${r.pn}${nameStr} — SPG ${Number(r.spg).toFixed(3)}`;

    // Use mousedown to beat input's key/blur handlers on mobile
    div.addEventListener('mousedown', (e) => {
      e.preventDefault();   // don't blur input / don't let other handlers interfere
      e.stopPropagation();
      selectProductByPN(r.pn);
    });

    list.appendChild(div);
  });

  host.appendChild(list);
  host.style.display = 'block';
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  fillBottleSelect();
  calc();
  await loadFromURL(DATA_URL);

  // Restore persisted selections
  const savedBottle = localStorage.getItem('pw_bottle');
  if (savedBottle && bottleTypes.some(b=>b.key===savedBottle)) { $('bottle').value = savedBottle; }
  const savedSpg = parseFloat(localStorage.getItem('pw_spg')||'');
  if (Number.isFinite(savedSpg)) { $('spg').value = String(savedSpg); }
  const savedPn = localStorage.getItem('pw_pn');
  if (savedPn) { 
    $('search').value = savedPn;
    // Try to restore the product record
    const restoredRec = findProductFlexible(savedPn);
    if (restoredRec) {
      currentProduct = restoredRec;
    }
  }
  calc();

  // Wire buttons
  $('searchBtn').addEventListener('click', lookupProduct);
  $('resetBtn').addEventListener('click', ()=>{
    localStorage.removeItem('pw_bottle');
    localStorage.removeItem('pw_spg');
    localStorage.removeItem('pw_pn');
    $('search').value = '';
    $('spg').value = '1.000';
    $('bottle').selectedIndex = 0;
    currentProduct = null; // Clear current product
    PRODUCTS.length ? setStatus('Reset. Enter a product number or SPG.', '') : setLoadStatus('Reset.', '');
    calc();
  });

  $('search').addEventListener('change', lookupProduct);
  $('search').addEventListener('keyup', (e) => { if (e.key === 'Enter') lookupProduct(); });
  $('search').addEventListener('input', (e) => {
    const q = e.target.value;
    if (!PRODUCTS.length || !q.trim()) { renderSuggestions([]); return; }
    renderSuggestions(getSuggestions(q));
  });
  ['spg','bottle'].forEach(id => {
    $(id).addEventListener('input', () => calc());
    $(id).addEventListener('change', () => calc());
  });
});
</script>
</body>
</html>
