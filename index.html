<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Product Weight Calculator</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--b:#ddd;--m:#666;--bg:#f7f7f7}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:2rem}
    .card{max-width:780px;padding:1.25rem;border:1px solid var(--b);border-radius:10px}
    h2{margin:0 0 .75rem 0}
    label{display:block;margin-top:.75rem;font-weight:600}
    input,select,button{width:100%;padding:.7rem;border:1px solid #ccc;border-radius:8px;font-size:1rem}
    .row{display:flex;gap:.8rem;flex-wrap:wrap}
    .row>div{flex:1;min-width:220px}
    .muted{color:var(--m);font-size:.92rem}
    .result{margin-top:1rem;padding:.9rem;background:var(--bg);border-radius:8px}
    .pill{display:inline-block;padding:.2rem .5rem;border:1px solid var(--b);border-radius:999px;margin-top:.35rem;font-size:.85rem}
    .ok{color:#155724;background:#d4edda;border-color:#c3e6cb}
    .warn{color:#856404;background:#fff3cd;border-color:#ffeeba}
    .err{color:#721c24;background:#f8d7da;border-color:#f5c6cb}
    button{cursor:pointer;background:#f4f4f4}
    button:hover{background:#eee}
    .drop{margin-top:.5rem;border:2px dashed var(--b);border-radius:8px;padding:.9rem;text-align:center;background:#fafafa}
    .drop.drag{background:#f0f7ff;border-color:#99c7ff}
    code{background:#f3f3f3;padding:.1rem .3rem;border-radius:4px}
  </style>
</head>
<body>
  <div class="card">
    <h2>Product Weight Calculator</h2>
    <div class="muted">
      Assumption: 1 gallon @ SPG 1.000 = <strong>8.34 lb</strong> (128 fl oz).<br>
      Net = (bottle_ounces × SPG × 8.34 / 128). Gross = Net + tare.
    </div>

    <!-- Data source controls -->
    <div class="row" style="margin-top:.75rem;align-items:flex-end;">
      <div>
        <label for="dataSource">Data source (XLSX URL)</label>
        <input id="dataSource" type="url" placeholder="https://raw.githubusercontent.com/<user>/<repo>/main/SPECIFIC%20GRAVITY.xlsx">
        <div class="muted">Point to your master .xlsx (GitHub raw, OneDrive <code>?download=1</code>, or Google Sheets Excel export).</div>
      </div>
      <div style="max-width:11rem">
        <button id="reloadBtn" type="button">Reload from URL</button>
      </div>
    </div>

    <label for="xlsx">Or load a local .xlsx file</label>
    <input id="xlsx" type="file" accept=".xlsx,.xls">
    <div id="dropzone" class="drop">Drag & drop your .xlsx here</div>
    <div id="loadStatus" class="muted" style="margin-top:.25rem;"></div>

    <!-- Search + bottle/SPG -->
    <label for="search" style="margin-top:1rem">Search Product Number (formula)</label>
    <input id="search" type="text" placeholder="Type product number and press Enter">
    <div id="searchStatus" class="muted" style="margin-top:.25rem;"></div>

    <div class="row" style="margin-top:.75rem;">
      <div>
        <label for="bottle">Bottle Type</label>
        <select id="bottle"></select>
      </div>
      <div>
        <label for="spg">Specific Gravity (SPG)</label>
        <input id="spg" type="number" step="0.001" min="0" value="1.000">
        <div class="muted">Auto-fills when a product is found. You can override.</div>
      </div>
    </div>

    <div id="result" class="result"></div>
  </div>

<script>
const GALLON_LBS_AT_SPG1 = 8.34;

// Bottle catalog (ounces + tare). Edit if you have exact tares.
const bottleTypes = [
  { key: "gallon_white_natural", name: "Gallon (White/Natural HDPE)", tare: 0.30, ounces: 128 },
  { key: "gallon_clear",         name: "Gallon (Clear/PET)",          tare: 0.32, ounces: 128 },
  { key: "half_gallon",          name: "Half Gallon",                  tare: 0.16, ounces: 64 },
  { key: "quart",                name: "Quart",                        tare: 0.08, ounces: 32 },
  { key: "pint",                 name: "Pint",                         tare: 0.05, ounces: 16 },
  { key: "8oz",                  name: "Bottle (8 oz)",                tare: 0.03, ounces: 8 },
  { key: "4oz",                  name: "Bottle (4 oz)",                tare: 0.02, ounces: 4 },
  { key: "drum_5gal",            name: "5 Gallon Pail",                tare: 1.80, ounces: 640 }
];

// ===== STATE =====
let PRODUCTS = []; // { pn, name, spg }
let XLSX_URL = ""; // persisted in localStorage
const $ = (id) => document.getElementById(id);

// ===== UI helpers =====
function setStatus(msg, kind='') {
  const s = $('searchStatus'); if (!s) return;
  s.textContent = msg || '';
  s.className = `${kind ? 'pill ' + kind : 'muted'}`;
}
function setLoadStatus(msg, kind='') {
  const s = $('loadStatus'); if (!s) return;
  s.textContent = msg || '';
  s.className = `${kind ? 'pill ' + kind : 'muted'}`;
}

function fillBottleSelect() {
  const sel = $('bottle');
  sel.innerHTML = "";
  bottleTypes.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.key;
    opt.textContent = `${b.name} – ${b.ounces} oz (tare ${b.tare.toFixed(3)} lb)`;
    sel.appendChild(opt);
  });
}

// ===== Header picking / normalization =====
const norm = (s) => String(s ?? '').trim().toLowerCase();
function pickHeader(objKeys, regexList) {
  const lower = objKeys.map(k => ({ orig: k, low: norm(k) }));
  for (const rx of regexList) {
    const re = new RegExp(rx);
    const hit = lower.find(({low}) => re.test(low));
    if (hit) return hit.orig;
  }
  return null;
}

// ===== Ingest rows (supports: formula, description, specific gravity) =====
function ingestRows(rows) {
  if (!Array.isArray(rows) || rows.length === 0) {
    setLoadStatus('No rows found in sheet.', 'err'); PRODUCTS = []; return;
  }
  const keys = Object.keys(rows[0] || {});
  const pnKey   = pickHeader(keys, ['\\bformula\\b','\\bproduct\\s*(no|num|number)?\\b','\\bsku\\b','\\bitem(\\s*no|\\s*number)?\\b','\\bpart(\\s*no|\\s*number)?\\b']);
  const spgKey  = pickHeader(keys, ['\\bspecific\\s*gravity\\b','\\bspg\\b','\\bsg\\b']);
  const nameKey = pickHeader(keys, ['\\bdescription\\b','\\bproduct\\s*name\\b','\\bname\\b','\\btitle\\b']);
  if (!pnKey || !spgKey) {
    setLoadStatus('Missing product number (formula) and/or SPG columns.', 'err'); PRODUCTS = []; return;
  }
  const seen = new Set(); const out = [];
  for (const r of rows) {
    const pn   = String(r[pnKey] ?? '').trim();
    const name = String(r[nameKey] ?? '').trim();
    const spg  = Number(r[spgKey]);
    if (!pn || !Number.isFinite(spg)) continue;
    const key = norm(pn);
    if (seen.has(key)) continue;
    seen.add(key);
    out.push({ pn, name, spg });
  }
  PRODUCTS = out;
  setLoadStatus(`Loaded ${PRODUCTS.length} products.`, 'ok');
}

// ===== XLSX loaders =====
function loadXLSXFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      if (!wb.SheetNames?.length) throw new Error('No sheets found');
      const ws = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
      ingestRows(rows);
    } catch (err) {
      setLoadStatus(`XLSX parse error: ${err.message}`, 'err'); PRODUCTS = [];
    }
  };
  reader.onerror = () => setLoadStatus('Failed to read file.', 'err');
  reader.readAsArrayBuffer(file);
}

async function fetchArrayBuffer(url) {
  const resp = await fetch(url, { cache: 'no-store' });
  if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
  return await resp.arrayBuffer();
}
async function loadFromURL(url) {
  if (!url) { setLoadStatus('Enter an XLSX URL.', 'warn'); return; }
  setLoadStatus('Loading spreadsheet…');
  try {
    const ab = await fetchArrayBuffer(url);
    const wb = XLSX.read(new Uint8Array(ab), { type: 'array' });
    if (!wb.SheetNames?.length) throw new Error('No sheets in workbook');
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });
    ingestRows(rows);
  } catch (err) {
    setLoadStatus(`Load failed: ${err.message}`, 'err'); PRODUCTS = [];
  }
}

// ===== Search & calc =====
function findProduct(pnRaw) {
  const key = norm(pnRaw);
  if (!key) return null;
  return PRODUCTS.find(r => norm(r.pn) === key) || null;
}

function lookupProduct() {
  const query = $('search').value;
  if (!PRODUCTS.length) { setStatus('No product list loaded. Upload or reload from URL.', 'warn'); return; }
  if (!query.trim())    { setStatus('Enter a product number to search.', ''); return; }
  const rec = findProduct(query);
  if (rec) {
    $('spg').value = String(rec.spg);
    const nameStr = rec.name ? ` • ${rec.name}` : '';
    setStatus(`Found ${rec.pn}${nameStr} → SPG ${Number(rec.spg).toFixed(3)}`, 'ok');
    calc(rec);
  } else {
    setStatus(`Product “${query}” not found. Type SPG manually.`, 'warn');
  }
}

function calc(rec=null) {
  const key = $('bottle').value;
  const bottle = bottleTypes.find(b => b.key === key) || bottleTypes[0];
  const spg = parseFloat($('spg').value || "0");
  const net = (bottle.ounces * spg * GALLON_LBS_AT_SPG1) / 128.0;
  const gross = net + bottle.tare;
  const productName = rec?.name ? ` • ${rec.name}` : '';
  $('result').innerHTML = `
    <div><strong>Net:</strong> ${Number.isFinite(net) ? net.toFixed(3) : '—'} lb</div>
    <div><strong>Gross:</strong> ${Number.isFinite(gross) ? gross.toFixed(3) : '—'} lb</div>
    <div class="muted">
      Product: ${rec?.pn ?? '—'}${productName}<br>
      Bottle: ${bottle.name} • ${bottle.ounces} oz • Tare ${bottle.tare.toFixed(3)} lb • SPG ${Number.isFinite(spg) ? spg.toFixed(3) : '—'}
    </div>
  `;
}

// ===== Wire up =====
document.addEventListener('DOMContentLoaded', () => {
  fillBottleSelect();
  calc();

  // Persist URL
  const saved = localStorage.getItem('product_xlsx_url');
  if (saved) { XLSX_URL = saved; $('dataSource').value = saved; }

  $('reloadBtn').addEventListener('click', async () => {
    XLSX_URL = $('dataSource').value.trim();
    if (!XLSX_URL) { setLoadStatus('Enter a valid XLSX URL.', 'warn'); return; }
    localStorage.setItem('product_xlsx_url', XLSX_URL);
    await loadFromURL(XLSX_URL);
  });

  // Local file
  $('xlsx').addEventListener('change', (e) => {
    const f = e.target.files && e.target.files[0];
    if (f) loadXLSXFile(f);
  });

  // Drag & drop
  const dz = $('dropzone');
  ;['dragenter','dragover'].forEach(ev => dz.addEventListener(ev, (e)=>{e.preventDefault(); dz.classList.add('drag');}));
  ;['dragleave','drop'].forEach(ev => dz.addEventListener(ev, (e)=>{e.preventDefault(); dz.classList.remove('drag');}));
  dz.addEventListener('drop', (e) => {
    const f = e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) loadXLSXFile(f);
  });

  // Search + calc
  $('search').addEventListener('change', lookupProduct);
  $('search').addEventListener('keyup', (e) => { if (e.key === 'Enter') lookupProduct(); });
  ['spg','bottle'].forEach(id => {
    $(id).addEventListener('input', () => calc());
    $(id).addEventListener('change', () => calc());
  });
});
</script>
</body>
</html>
