<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Product Weight Calculator</title>
  <link rel="icon" type="image/png" href="IMG_0274.png">
  <link rel="apple-touch-icon" href="IMG_0274.png">
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{
      --bg:#f5f7fa;
      --panel:#ffffff;
      --text:#2d3748;
      --muted:#718096;
      --accent:#3182ce;
      --accent-dark:#2c5282;
      --border:#e2e8f0;
      --line-accent:#4299e1;
      --line-bg:#ebf8ff;
      --hover:#f7fafc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
    }
    header{
      padding:28px 40px;
      background:linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      color:white;
      box-shadow:0 4px 6px rgba(0,0,0,.1);
      position:sticky; top:0; z-index:10;
    }
    .header-content{
      display:flex;
      justify-content:space-between;
      align-items:center;
      flex-wrap:wrap;
      gap:20px;
      max-width:1600px;
      margin:0 auto;
    }
    header h1{
      margin:0; 
      font-size:28px; 
      font-weight:700; 
      letter-spacing:-0.8px;
      text-shadow:0 2px 4px rgba(0,0,0,.1);
    }
    main{
      padding:32px 40px;
      max-width:1600px;
      margin:0 auto;
    }
    .card{
      max-width:900px;
      margin:0 auto;
      padding:24px;
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    h2{
      margin:0 0 1rem 0;
      font-size:22px;
      font-weight:700;
      color:var(--text);
    }
    label{
      display:block;
      margin-top:1rem;
      font-weight:600;
      color:var(--text);
      font-size:14px;
    }
    input, select{
      width:100%;
      padding:11px 14px;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:14px;
      background:white;
      color:var(--text);
      transition:all 0.2s ease;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    input:focus, select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px rgba(49,130,206,.1);
    }
    select{
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%233182ce' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 14px center;
      padding-right:40px;
      cursor:pointer;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
    }
    .row>div{
      flex:1;
      min-width:220px;
    }
    .muted{
      color:var(--muted);
      font-size:13px;
    }
    .result{
      margin-top:1.5rem;
      padding:20px;
      background:linear-gradient(to right, #f8fafc, #f1f5f9);
      border-radius:10px;
      border:1px solid var(--border);
    }
    .result strong{
      color:var(--accent);
      font-weight:600;
    }
    .pill{
      display:inline-block;
      padding:6px 12px;
      border-radius:6px;
      margin-top:8px;
      font-size:12px;
      font-weight:600;
    }
    .ok{
      color:#155724;
      background:#d4edda;
      border:1px solid #c3e6cb;
    }
    .warn{
      color:#856404;
      background:#fff3cd;
      border:1px solid #ffeeba;
    }
    .err{
      color:#721c24;
      background:#f8d7da;
      border:1px solid #f5c6cb;
    }
    button{
      appearance:none;
      border:1px solid var(--accent);
      border-radius:8px;
      padding:11px 24px;
      font-size:14px;
      cursor:pointer;
      background:var(--accent);
      color:white;
      font-weight:600;
      transition:all 0.2s ease;
      box-shadow:0 1px 2px rgba(0,0,0,.05);
    }
    button:hover{
      background:var(--accent-dark);
      border-color:var(--accent-dark);
      transform:translateY(-1px);
      box-shadow:0 4px 6px rgba(0,0,0,.1);
    }
    button:active{
      transform:translateY(0);
    }
    button.primary{
      background:var(--accent);
      border-color:var(--accent);
    }
    .actions{
      display:flex;
      gap:12px;
      margin-top:1rem;
    }
    .suggestions{
      position:relative;
      margin-top:8px;
    }
    .suggestions-list{
      position:absolute;
      z-index:10;
      left:0;
      right:0;
      background:white;
      border:1px solid var(--border);
      border-radius:8px;
      max-height:220px;
      overflow:auto;
      box-shadow:0 4px 14px rgba(0,0,0,.12);
    }
    .suggestions-item{
      padding:12px 16px;
      cursor:pointer;
      transition:background 0.15s ease;
    }
    .suggestions-item:hover{
      background:var(--hover);
    }
    .suggestions-empty{
      padding:12px 16px;
      color:var(--muted);
    }
    .footer-info{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:2rem;
      padding-top:1.5rem;
      border-top:1px solid var(--border);
    }
    .footer-info img{
      height:50px;
      opacity:0.9;
    }
    .footer-nav{
      display:flex;
      align-items:center;
      gap:16px;
    }
    .footer-nav a{
      color:var(--accent);
      text-decoration:none;
      font-weight:500;
      font-size:13px;
      transition:color 0.2s ease;
    }
    .footer-nav a:hover{
      color:var(--accent-dark);
      text-decoration:underline;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <h1>Product Weight Calculator</h1>
    </div>
  </header>
  <main>
    <div class="card">
      <h2>Product Weight Calculator</h2> 
    <div class="muted">
      Assumption: 1 gallon @ SPG 1.000 = <strong>8.34 lb</strong> (128 fl oz).<br>
      Net = (bottle_ounces × SPG × 8.34 / 128). Gross = Net + tare.
    </div>

    <div id="loadStatus" class="muted" style="margin-top:.5rem;"></div>

    <label for="search" style="margin-top:1rem">Search by Item Number (formula) or Product Name</label>
    <div class="row">
      <div style="flex:2;min-width:260px">
        <input id="search" type="text" placeholder="Type item number or name; press Enter or click Search">
      </div>
      <div style="flex:0 0 auto;min-width:120px">
        <button id="searchBtn" class="primary" style="width:100%">Search</button>
      </div>
    </div>
    <div id="searchStatus" class="muted" style="margin-top:.25rem;"></div>
    <div id="suggestions" class="suggestions"></div>

    <div class="row" style="margin-top:.75rem;">
      <div>
        <label for="bottle">Bottle Type</label>
        <select id="bottle"></select>
      </div>
      <div>
        <label for="spg">Specific Gravity (SPG)</label>
        <input id="spg" type="number" step="0.001" min="0" value="1.000">
        <div class="muted">Auto-fills on match. You can override.</div>
      </div>
    </div>

    <div id="result" class="result"></div>
    <div class="actions">
      <button id="resetBtn" title="Clear selections">Reset</button>
    </div>
      <div class="footer-info">
        <div>
          <div class="muted" style="font-size:13px;">App made by <strong>J.L.</strong></div>
          <div class="footer-nav" style="margin-top:8px;">
            <a href="/schedule">Production Schedule</a>
          </div>
        </div>
        <img src="maintex-logo.jpg" alt="Maintex Logo">
      </div>
    </div>
  </main>

<script>
/* ---------- CONFIG: single authoritative source ---------- */
const DATA_URL = "https://docs.google.com/spreadsheets/d/16_KVPSr7VIsCExEo-TPRnT8iI1Bd2rFDSNIj-JlLFMc/export?format=xlsx";

/* ---------- Constants ---------- */
const GALLON_LBS_AT_SPG1 = 8.34;

/* Bottle catalog (ounces + tare). Update if you have exact tares. */
const bottleTypes = [
  { key: "clear_round",          name: "Clear Round Bottle",           tare: 0.24, ounces: 160 },
  { key: "nat_160",              name: "Natural 160oz Bottle",         tare: 0.32, ounces: 160 },
  { key: "gallon_white_natural", name: "Gallon (White/Natural)",       tare: 0.30, ounces: 128 },
  { key: "gallon_fstyle",        name: "Gallon (F-Style)",             tare: 0.43, ounces: 128 },
  { key: "2liter_gallon",        name: "2L Clear Bottle",              tare: 0.16, ounces: 67 },
  { key: "half_gallon",          name: "Half Gallon",                  tare: 0.27, ounces: 64 },
  { key: "quart",                name: "White/Natural Quart",          tare: 0.13, ounces: 32 },
  { key: "white_flat_quart",     name: "White Flat Quart",             tare: 0.18, ounces: 32 },
  { key: "clear_quart",          name: "Clear Quart",                  tare: 0.11, ounces: 32 },
  { key: "30oz",                 name: "30oz Bottle",                  tare: 0.11, ounces: 30 },
  { key: "pint",                 name: "Pint",                         tare: 0.14, ounces: 16 },
  { key: "8oz",                  name: "Bottle (8 oz)",                tare: 0.03, ounces: 8 },
  { key: "pail_5gal",            name: "5 Gallon Pail",                tare: 3.06, ounces: 640 }
];

/* ---------- State ---------- */
let PRODUCTS = []; // { pn, name, spg }
const $ = (id) => document.getElementById(id);

/* ---------- UI helpers ---------- */
function setStatus(msg, kind='') {
  const s = $('searchStatus'); if (!s) return;
  s.textContent = msg || '';
  s.className = `${kind ? 'pill ' + kind : 'muted'}`;
}
function setLoadStatus(msg, kind='') {
  const s = $('loadStatus'); if (!s) return;
  s.textContent = msg || '';
  s.className = `${kind ? 'pill ' + kind : 'muted'}`;
}

function fillBottleSelect() {
  const sel = $('bottle');
  sel.innerHTML = "";
  bottleTypes.forEach(b => {
    const opt = document.createElement('option');
    opt.value = b.key;
    opt.textContent = `${b.name} – ${b.ounces} oz (tare ${b.tare.toFixed(3)} lb)`;
    sel.appendChild(opt);
  });
}

/* ---------- Header picking / normalization ---------- */
const norm = (s) => String(s ?? '').trim().toLowerCase();
function pickHeader(objKeys, regexList) {
  const lower = objKeys.map(k => ({ orig: k, low: norm(k) }));
  for (const rx of regexList) {
    const re = new RegExp(rx);
    const hit = lower.find(({low}) => re.test(low));
    if (hit) return hit.orig;
  }
  return null;
}

/* ---------- Ingest rows (formula, description, specific gravity) ---------- */
function ingestRows(rows) {
  if (!Array.isArray(rows) || rows.length === 0) {
    setLoadStatus('No rows found in sheet.', 'err'); PRODUCTS = []; return;
  }
  const keys = Object.keys(rows[0] || {});
  const pnKey   = pickHeader(keys, ['\\bformula\\b','\\bproduct\\s*(no|num|number)?\\b','\\bsku\\b','\\bitem(\\s*no|\\s*number)?\\b','\\bpart(\\s*no|\\s*number)?\\b']);
  const spgKey  = pickHeader(keys, ['\\bspecific\\s*gravity\\b','\\bspg\\b','\\bsg\\b']);
  const nameKey = pickHeader(keys, ['\\bdescription\\b','\\bproduct\\s*name\\b','\\bname\\b','\\btitle\\b']);
  if (!pnKey || !spgKey) {
    setLoadStatus('Missing product number (formula) and/or SPG columns.', 'err'); PRODUCTS = []; return;
  }
  const seen = new Set(); const out = [];
  for (const r of rows) {
    const pn   = String(r[pnKey] ?? '').trim();
    const name = String(r[nameKey] ?? '').trim();
    const spg  = Number(r[spgKey]);
    if (!pn || !Number.isFinite(spg)) continue;
    const key = norm(pn);
    if (seen.has(key)) continue;
    seen.add(key);
    out.push({ pn, name, spg });
  }
  PRODUCTS = out;
  setLoadStatus(`Loaded ${PRODUCTS.length} products from SG Sheet.`, 'ok');
}

/* ---------- XLSX loader (from fixed URL) ---------- */
  function getFilenameFromHeaders(resp) {
  const cd = resp.headers.get('content-disposition');
  if (!cd) return null;
  // patterns: filename="NAME.xlsx"  |  filename*=UTF-8''NAME.xlsx
  const star = cd.match(/filename\*\s*=\s*[^']*''([^;]+)/i);
  if (star && star[1]) return decodeURIComponent(star[1]).replace(/["]/g,'').trim();
  const plain = cd.match(/filename\s*=\s*"([^"]+)"/i) || cd.match(/filename\s*=\s*([^;]+)/i);
  if (plain && plain[1]) return plain[1].replace(/["]/g,'').trim();
  return null;
}

function getTitleFromWorkbook(wb) {
  // SheetJS populates Props.Title for many sources; fallback to first sheet name.
  if (wb && wb.Props && wb.Props.Title) return String(wb.Props.Title).trim();
  if (wb && Array.isArray(wb.SheetNames) && wb.SheetNames.length) return String(wb.SheetNames[0]).trim();
  return null;
}

 async function loadFromURL(url) {
  setLoadStatus('Loading spreadsheet…');
  try {
    const resp = await fetch(url, { cache: 'no-store' });
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    // Try to get a real filename from headers first
    let fileName = getFilenameFromHeaders(resp);

    const ab = await resp.arrayBuffer();
    const wb = XLSX.read(new Uint8Array(ab), { type: 'array' });

    if (!wb.SheetNames?.length) throw new Error('No sheets in workbook');
    const ws = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(ws, { defval: '' });

    ingestRows(rows);

    // If no header-derived filename, fall back to workbook metadata/sheet name
    if (!fileName) {
      const title = getTitleFromWorkbook(wb);
      if (title) {
        // Ensure it looks like a file name
        fileName = title.endsWith('.xlsx') ? title : `${title}.xlsx`;
      }
    }

    // Final fallback: last URL segment (your current behavior)
    if (!fileName) {
      fileName = url.split('/').pop().split('?')[0] || 'data.xlsx';
      if (!/\.xlsx$/i.test(fileName)) fileName += '.xlsx';
    }

    setLoadStatus(`Loaded ${PRODUCTS.length} products from "${fileName}".`, 'ok');

  } catch (err) {
    setLoadStatus(`Load failed: ${err.message}. Ensure the sheet is public and the link uses /export?format=xlsx.`, 'err');
    PRODUCTS = [];
  }
}



/* ---------- Search & calc ---------- */
function findProduct(pnRaw) {
  const key = norm(pnRaw);
  if (!key) return null;
  return PRODUCTS.find(r => norm(r.pn) === key) || null;
}

function findProductFlexible(qRaw){
  const q = norm(qRaw);
  if (!q) return null;
  // exact item number
  let hit = PRODUCTS.find(r => norm(r.pn) === q);
  if (hit) return hit;
  // exact name
  hit = PRODUCTS.find(r => norm(r.name) === q);
  if (hit) return hit;
  // contains in pn or name
  hit = PRODUCTS.find(r => norm(r.pn).includes(q) || norm(r.name).includes(q));
  return hit || null;
}

function getSuggestions(qRaw, limit=8){
  const q = norm(qRaw);
  if (!q) return [];
  const scored = PRODUCTS.map(r => {
    const pn = norm(r.pn), nm = norm(r.name);
    let score = 0;
    if (pn.startsWith(q)) score += 3;
    if (nm.startsWith(q)) score += 2;
    if (pn.includes(q)) score += 1;
    if (nm.includes(q)) score += 1;
    return { r, score };
  }).filter(x => x.score > 0);
  scored.sort((a,b) => b.score - a.score);
  return scored.slice(0, limit).map(x => x.r);
}

function lookupProduct() {
  const query = $('search').value;
  if (!PRODUCTS.length) { setStatus('Data not loaded yet. Check status above.', 'warn'); return; }
  if (!query.trim())    { setStatus('Enter an item number or name to search.', ''); renderSuggestions([]); return; }
  const rec = findProductFlexible(query);
  if (rec) {
    $('spg').value = String(rec.spg);
    const nameStr = rec.name ? ` • ${rec.name}` : '';
    setStatus(`Found ${rec.pn}${nameStr} → SPG ${Number(rec.spg).toFixed(3)}`, 'ok');
    localStorage.setItem('pw_pn', rec.pn);
    calc(rec);
    renderSuggestions([]);
  } else {
    setStatus(`No exact match. Suggestions shown below…`, 'warn');
    renderSuggestions(getSuggestions(query));
  }
}

function calc(rec=null) {
  const key = $('bottle').value;
  const bottle = bottleTypes.find(b => b.key === key) || bottleTypes[0];
  const spg = parseFloat($('spg').value || "0");
  const net = (bottle.ounces * spg * GALLON_LBS_AT_SPG1) / 128.0;
  const gross = net + bottle.tare;
  const productName = rec?.name ? ` • ${rec.name}` : '';
  localStorage.setItem('pw_bottle', bottle.key);
  if (Number.isFinite(spg)) localStorage.setItem('pw_spg', String(spg));
  if (rec?.pn) localStorage.setItem('pw_pn', rec.pn);
  $('result').innerHTML = `
    <div><strong>Net:</strong> ${Number.isFinite(net) ? net.toFixed(3) : '—'} lb</div>
    <div><strong>Gross:</strong> ${Number.isFinite(gross) ? gross.toFixed(3) : '—'} lb</div>
    <div class="muted">
      Product: ${rec?.pn ?? '—'}${productName}<br>
      Bottle: ${bottle.name} • ${bottle.ounces} oz • Tare ${bottle.tare.toFixed(3)} lb • SPG ${Number.isFinite(spg) ? spg.toFixed(3) : '—'}
    </div>
  `;
}

function selectProductByPN(pnRaw) {
  const key = (pnRaw ?? '').toString().trim().toLowerCase();
  const rec = PRODUCTS.find(x => (x.pn ?? '').toString().trim().toLowerCase() === key);
  if (!rec) { setStatus(`Item “${pnRaw}” not found.`, 'warn'); return; }
  $('search').value = rec.pn;               // show the PN in the box
  $('spg').value = String(rec.spg);         // set SPG
  setStatus(`Found ${rec.pn}${rec.name ? ' • ' + rec.name : ''} → SPG ${Number(rec.spg).toFixed(3)}`, 'ok');
  renderSuggestions([]);                    // hide suggestions
  localStorage.setItem('pw_pn', rec.pn);    // persist
  calc(rec);                                // compute with the exact record
}


function renderSuggestions(items){
  const host = $('suggestions');
  if (!host) return;
  host.style.display = 'none';
  host.innerHTML = '';

  if (!items || !items.length){
    // keep empty hidden
    return;
  }

  const list = document.createElement('div');
  list.className = 'suggestions-list';

  items.forEach(r => {
    const div = document.createElement('div');
    div.className = 'suggestions-item';
    const nameStr = r.name ? ` • ${r.name}` : '';
    div.textContent = `${r.pn}${nameStr} — SPG ${Number(r.spg).toFixed(3)}`;

    // Use mousedown to beat input's key/blur handlers on mobile
    div.addEventListener('mousedown', (e) => {
      e.preventDefault();   // don't blur input / don't let other handlers interfere
      e.stopPropagation();
      selectProductByPN(r.pn);
    });

    list.appendChild(div);
  });

  host.appendChild(list);
  host.style.display = 'block';
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  fillBottleSelect();
  calc();
  await loadFromURL(DATA_URL);

  // Restore persisted selections
  const savedBottle = localStorage.getItem('pw_bottle');
  if (savedBottle && bottleTypes.some(b=>b.key===savedBottle)) { $('bottle').value = savedBottle; }
  const savedSpg = parseFloat(localStorage.getItem('pw_spg')||'');
  if (Number.isFinite(savedSpg)) { $('spg').value = String(savedSpg); }
  const savedPn = localStorage.getItem('pw_pn');
  if (savedPn) { $('search').value = savedPn; }
  calc();

  // Wire buttons
  $('searchBtn').addEventListener('click', lookupProduct);
  $('resetBtn').addEventListener('click', ()=>{
    localStorage.removeItem('pw_bottle');
    localStorage.removeItem('pw_spg');
    localStorage.removeItem('pw_pn');
    $('search').value = '';
    $('spg').value = '1.000';
    $('bottle').selectedIndex = 0;
    PRODUCTS.length ? setStatus('Reset. Enter a product number or SPG.', '') : setLoadStatus('Reset.', '');
    calc();
  });

  $('search').addEventListener('change', lookupProduct);
  $('search').addEventListener('keyup', (e) => { if (e.key === 'Enter') lookupProduct(); });
  $('search').addEventListener('input', (e) => {
    const q = e.target.value;
    if (!PRODUCTS.length || !q.trim()) { renderSuggestions([]); return; }
    renderSuggestions(getSuggestions(q));
  });
  ['spg','bottle'].forEach(id => {
    $(id).addEventListener('input', () => calc());
    $(id).addEventListener('change', () => calc());
  });
});
</script>
</body>
</html>
